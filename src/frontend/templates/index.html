{% extends "base.html" %}

{% block title %}Dashboard - Phosor{% endblock %}

{% block content %}
<div x-data="dashboard()" x-init="init()" x-cloak>
    <!-- Loading State -->
    <div x-show="loading" class="flex justify-center items-center h-64">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
    </div>

    <!-- Error State -->
    <div x-show="error" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
        <p class="text-red-800" x-text="error"></p>
    </div>

    <!-- Statistics Card -->
    <div x-show="!loading && !error" class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Overview</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-indigo-50 rounded-lg p-4">
                <p class="text-sm text-indigo-600 font-medium">Total Clusters</p>
                <p class="text-3xl font-bold text-indigo-900" x-text="stats.totalClusters"></p>
            </div>
            <div class="bg-green-50 rounded-lg p-4">
                <p class="text-sm text-green-600 font-medium">Total Detections</p>
                <p class="text-3xl font-bold text-green-900" x-text="stats.totalFaces"></p>
            </div>
            <div class="bg-purple-50 rounded-lg p-4">
                <p class="text-sm text-purple-600 font-medium">Total Images</p>
                <p class="text-3xl font-bold text-purple-900" x-text="stats.totalImages"></p>
            </div>
        </div>
    </div>

    <!-- Clusters Grid -->
    <div x-show="!loading && !error">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-gray-900">Clusters</h2>
            <div class="flex gap-2">
                <button @click="showCreateModal()"
                    class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    + New Cluster
                </button>
                <button @click="refreshClusters()"
                    class="px-4 py-2 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                    Refresh
                </button>
            </div>
        </div>

        <!-- Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <template x-for="cluster in clusters" :key="cluster.cluster_id">
                <div class="bg-white rounded-lg shadow-sm overflow-hidden hover:shadow-md transition">
                    <!-- Representative Image -->
                    <div class="aspect-square bg-gray-100 relative overflow-hidden">
                        <img :src="`/api/images/representative/${cluster.label}`" :alt="cluster.label"
                            class="w-full h-full object-cover" loading="lazy"
                            @error="$event.target.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 200 200%22%3E%3Crect fill=%22%23ddd%22 width=%22200%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2216%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                    </div>

                    <!-- Cluster Info -->
                    <div class="p-4">
                        <h3 class="font-semibold text-gray-900 mb-1 truncate" x-text="cluster.label"></h3>
                        <p class="text-sm text-gray-600 mb-3">
                            <span x-text="cluster.num_images"></span> images
                        </p>

                        <!-- Actions -->
                        <div class="flex gap-2">
                            <button @click="viewCluster(cluster)"
                                class="flex-1 px-3 py-1.5 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
                                View
                            </button>
                            <button @click="startRename(cluster)"
                                class="px-3 py-1.5 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">
                                Rename
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Empty State -->
        <div x-show="clusters.length === 0" class="text-center py-12 bg-white rounded-lg shadow-sm">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No clusters found</h3>
            <p class="mt-1 text-sm text-gray-500">Run the scan command to detect and cluster faces.</p>
        </div>
    </div>

    <!-- Unclustered Images Section -->
    <div x-show="!loading && !error && unclusteredImages.length > 0" class="mt-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-gray-900">Unclustered Images</h2>
            <span class="text-sm text-gray-500" x-text="`${unclusteredImages.length} images`"></span>
        </div>

        <!-- Unclustered Grid (same width as clusters) -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <template x-for="image in unclusteredImages" :key="image.filename">
                <div class="bg-white rounded-lg shadow-sm overflow-hidden hover:shadow-md transition">
                    <!-- Image -->
                    <div class="aspect-square bg-gray-100 relative overflow-hidden">
                        <img :src="`/api/images/unclustered/${image.filename}`" :alt="image.filename"
                            class="w-full h-full object-cover cursor-pointer" @click="viewUnclusteredImage(image)"
                            loading="lazy"
                            @error="$event.target.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 200 200%22%3E%3Crect fill=%22%23ddd%22 width=%22200%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2216%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                    </div>

                    <!-- Image Info -->
                    <div class="p-4">
                        <div class="flex items-center justify-between">
                            <p class="text-sm text-gray-600 truncate flex-1 mr-2" :title="image.filename"
                                x-text="image.filename"></p>
                            <button @click="startMoveImage(image)"
                                class="p-1.5 text-indigo-600 hover:bg-indigo-50 rounded transition"
                                title="Move to cluster">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Rename Modal -->
    <div x-show="renameModal.show" @click.self="closeRenameModal()"
        class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Rename Cluster</h3>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Current Name</label>
                <p class="text-gray-900" x-text="renameModal.cluster?.label"></p>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">New Name</label>
                <input type="text" x-model="renameModal.newLabel" @keyup.enter="submitRename()"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    placeholder="Enter new cluster name">
            </div>

            <div class="flex gap-3">
                <button @click="submitRename()" :disabled="renameModal.loading || !renameModal.newLabel"
                    class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
                    <span x-show="!renameModal.loading">Rename</span>
                    <span x-show="renameModal.loading">Renaming...</span>
                </button>
                <button @click="closeRenameModal()" :disabled="renameModal.loading"
                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 transition">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Create Cluster Modal -->
    <div x-show="createModal.show" @click.self="closeCreateModal()"
        class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Create New Cluster</h3>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Cluster Name</label>
                <input type="text" x-model="createModal.label" @keyup.enter="submitCreate()"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    placeholder="Enter cluster name (e.g., John Doe)">
            </div>

            <div class="flex gap-3">
                <button @click="submitCreate()" :disabled="createModal.loading || !createModal.label"
                    class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
                    <span x-show="!createModal.loading">Create</span>
                    <span x-show="createModal.loading">Creating...</span>
                </button>
                <button @click="closeCreateModal()" :disabled="createModal.loading"
                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 transition">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Move Image Modal -->
    <div x-show="moveModal.show" @click.self="closeMoveModal()"
        class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Copy Image to Cluster(s)</h3>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Image</label>
                <p class="text-sm text-gray-600 truncate" x-text="moveModal.image?.filename"></p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Existing Clusters</label>

                <!-- Search Box -->
                <input type="text" x-model="moveModal.searchQuery" @input="filterClusters()"
                    class="w-full px-3 py-2 mb-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    placeholder="Search clusters...">

                <!-- Cluster List -->
                <div class="border border-gray-300 rounded-lg p-3 max-h-48 overflow-y-auto">
                    <template x-for="cluster in filteredClusters" :key="cluster.cluster_id">
                        <label class="flex items-center py-2 hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" :value="cluster.cluster_id" x-model="moveModal.selectedClusterIds"
                                class="mr-3 h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <span class="text-sm text-gray-700" x-text="cluster.label"></span>
                        </label>
                    </template>
                    <div x-show="filteredClusters.length === 0" class="text-sm text-gray-400 py-2 text-center">
                        No clusters found
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" x-model="moveModal.createNew"
                        class="mr-2 h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <span class="text-sm font-medium text-gray-700">Create new cluster</span>
                </label>
            </div>

            <div x-show="moveModal.createNew" class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">New Cluster Name</label>
                <input type="text" x-model="moveModal.newClusterName" @keyup.enter="submitMoveImage()"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    placeholder="Enter new cluster name">
            </div>

            <div class="flex gap-3">
                <button @click="submitMoveImage()"
                    :disabled="moveModal.loading || (!moveModal.selectedClusterIds.length && !moveModal.createNew) || (moveModal.createNew && !moveModal.newClusterName)"
                    class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
                    <span x-show="!moveModal.loading">Copy</span>
                    <span x-show="moveModal.loading">Copying...</span>
                </button>
                <button @click="closeMoveModal()" :disabled="moveModal.loading"
                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 transition">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function dashboard() {
        return {
            loading: true,
            error: null,
            clusters: [],
            unclusteredImages: [],
            stats: {
                totalClusters: 0,
                totalFaces: 0,
                totalImages: 0,
            },
            renameModal: {
                show: false,
                cluster: null,
                newLabel: '',
                loading: false,
            },
            createModal: {
                show: false,
                label: '',
                loading: false,
            },
            moveModal: {
                show: false,
                image: null,
                selectedClusterIds: [],
                createNew: false,
                newClusterName: '',
                searchQuery: '',
                loading: false,
            },
            filteredClusters: [],
            _initialized: false,

            // Cache settings
            CACHE_KEY_CLUSTERS: 'phosor_clusters',
            CACHE_KEY_UNCLUSTERED: 'phosor_unclustered',
            CACHE_TTL: 5 * 60 * 1000, // 5 minutes in milliseconds

            async init() {
                // Prevent double initialization
                if (this._initialized) {
                    console.log('Dashboard already initialized, skipping...');
                    return;
                }
                this._initialized = true;

                // Try to load from cache first (instant)
                this.loadFromCache();

                // Then refresh from API in background
                await this.loadClusters();
                await this.loadUnclusteredImages();
            },

            loadFromCache() {
                // Load clusters from cache
                const cachedClusters = this.getCachedData(this.CACHE_KEY_CLUSTERS);
                if (cachedClusters) {
                    this.clusters = cachedClusters;
                    this.calculateStats();
                    this.loading = false;
                    console.log('âœ… Loaded clusters from cache');
                }

                // Load unclustered from cache
                const cachedUnclustered = this.getCachedData(this.CACHE_KEY_UNCLUSTERED);
                if (cachedUnclustered) {
                    this.unclusteredImages = cachedUnclustered;
                    console.log('âœ… Loaded unclustered from cache');
                }
            },

            getCachedData(key) {
                try {
                    const cached = localStorage.getItem(key);
                    if (!cached) return null;

                    const { data, timestamp } = JSON.parse(cached);
                    const age = Date.now() - timestamp;

                    // Check if cache is still valid
                    if (age < this.CACHE_TTL) {
                        return data;
                    } else {
                        // Cache expired, remove it
                        localStorage.removeItem(key);
                        return null;
                    }
                } catch (err) {
                    console.error('Cache read error:', err);
                    return null;
                }
            },

            setCachedData(key, data) {
                try {
                    const cacheEntry = {
                        data: data,
                        timestamp: Date.now(),
                    };
                    localStorage.setItem(key, JSON.stringify(cacheEntry));
                } catch (err) {
                    console.error('Cache write error:', err);
                }
            },

            invalidateCache() {
                localStorage.removeItem(this.CACHE_KEY_CLUSTERS);
                localStorage.removeItem(this.CACHE_KEY_UNCLUSTERED);
                console.log('ðŸ—‘ï¸ Cache invalidated');
            },

            async loadClusters() {
                this.error = null;

                try {
                    const response = await fetch('/api/clusters');
                    if (!response.ok) {
                        throw new Error(`Failed to load clusters: ${response.statusText}`);
                    }

                    this.clusters = await response.json();
                    // Sort alphabetically by label
                    this.clusters.sort((a, b) => a.label.localeCompare(b.label));
                    this.calculateStats();

                    // Save to cache
                    this.setCachedData(this.CACHE_KEY_CLUSTERS, this.clusters);
                    console.log('ðŸ’¾ Clusters cached');
                } catch (err) {
                    this.error = err.message;
                    console.error('Error loading clusters:', err);
                } finally {
                    this.loading = false;
                }
            },

            calculateStats() {
                this.stats.totalClusters = this.clusters.length;
                this.stats.totalFaces = this.clusters.reduce((sum, c) => sum + c.num_faces, 0);
                this.stats.totalImages = this.clusters.reduce((sum, c) => sum + c.num_images, 0);
            },

            async loadUnclusteredImages() {
                try {
                    const response = await fetch('/api/unclustered');
                    if (!response.ok) {
                        throw new Error(`Failed to load unclustered images: ${response.statusText}`);
                    }
                    this.unclusteredImages = await response.json();

                    // Save to cache
                    this.setCachedData(this.CACHE_KEY_UNCLUSTERED, this.unclusteredImages);
                    console.log('ðŸ’¾ Unclustered images cached');
                } catch (err) {
                    console.error('Error loading unclustered images:', err);
                    // Don't show error for unclustered - it's optional
                }
            },

            async refreshClusters() {
                this.loading = true;
                this.invalidateCache();
                await this.loadClusters();
                await this.loadUnclusteredImages();
            },

            viewCluster(cluster) {
                // Navigate to cluster detail page
                window.location.href = `/cluster/${cluster.cluster_id}`;
            },

            viewUnclusteredImage(image) {
                // Open in new tab or implement lightbox
                window.open(`/api/images/unclustered/${image.filename}`, '_blank');
            },

            startRename(cluster) {
                this.renameModal.show = true;
                this.renameModal.cluster = cluster;
                this.renameModal.newLabel = cluster.label;
            },

            closeRenameModal() {
                if (!this.renameModal.loading) {
                    this.renameModal.show = false;
                    this.renameModal.cluster = null;
                    this.renameModal.newLabel = '';
                }
            },

            async submitRename() {
                if (!this.renameModal.newLabel || this.renameModal.loading) return;

                this.renameModal.loading = true;

                try {
                    const response = await fetch(`/api/clusters/${this.renameModal.cluster.cluster_id}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            label: this.renameModal.newLabel,
                        }),
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.detail || 'Failed to rename cluster');
                    }

                    // Invalidate cache and refresh
                    this.invalidateCache();
                    await this.loadClusters();
                    this.closeRenameModal();
                } catch (err) {
                    alert(`Error: ${err.message}`);
                    console.error('Error renaming cluster:', err);
                } finally {
                    this.renameModal.loading = false;
                }
            },

            showCreateModal() {
                this.createModal.show = true;
                this.createModal.label = '';
            },

            closeCreateModal() {
                if (!this.createModal.loading) {
                    this.createModal.show = false;
                    this.createModal.label = '';
                }
            },

            async submitCreate() {
                if (!this.createModal.label || this.createModal.loading) return;

                this.createModal.loading = true;

                try {
                    const response = await fetch('/api/clusters', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            label: this.createModal.label,
                        }),
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.detail || 'Failed to create cluster');
                    }

                    // Invalidate cache and refresh
                    this.invalidateCache();
                    await this.loadClusters();
                    this.closeCreateModal();
                } catch (err) {
                    alert(`Error: ${err.message}`);
                    console.error('Error creating cluster:', err);
                } finally {
                    this.createModal.loading = false;
                }
            },

            startMoveImage(image) {
                this.moveModal.show = true;
                this.moveModal.image = image;
                this.moveModal.selectedClusterIds = [];
                this.moveModal.createNew = false;
                this.moveModal.newClusterName = '';
                this.moveModal.searchQuery = '';
                this.filteredClusters = [...this.clusters]; // Initialize with all clusters
            },

            closeMoveModal() {
                if (!this.moveModal.loading) {
                    this.moveModal.show = false;
                    this.moveModal.image = null;
                    this.moveModal.selectedClusterIds = [];
                    this.moveModal.createNew = false;
                    this.moveModal.newClusterName = '';
                    this.moveModal.searchQuery = '';
                    this.filteredClusters = [];
                }
            },

            filterClusters() {
                const query = this.moveModal.searchQuery.toLowerCase();
                if (!query) {
                    this.filteredClusters = [...this.clusters];
                } else {
                    this.filteredClusters = this.clusters.filter(c =>
                        c.label.toLowerCase().includes(query)
                    );
                }
            },

            async submitMoveImage() {
                // Validate: must select at least one cluster OR create new
                if (!this.moveModal.selectedClusterIds.length && !this.moveModal.createNew) return;
                if (this.moveModal.createNew && !this.moveModal.newClusterName) return;
                if (this.moveModal.loading) return;

                this.moveModal.loading = true;

                try {
                    const response = await fetch('/api/images/move-multiple', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            filename: this.moveModal.image.filename,
                            target_cluster_ids: this.moveModal.selectedClusterIds.map(id => parseInt(id)),
                            create_new_cluster: this.moveModal.createNew ? this.moveModal.newClusterName : null,
                        }),
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.detail || 'Failed to move image');
                    }

                    // Invalidate cache and refresh both clusters and unclustered images
                    this.invalidateCache();
                    await this.loadClusters();
                    await this.loadUnclusteredImages();
                    this.closeMoveModal();
                } catch (err) {
                    alert(`Error: ${err.message}`);
                    console.error('Error moving image:', err);
                } finally {
                    this.moveModal.loading = false;
                }
            },
        };
    }
</script>
{% endblock %}